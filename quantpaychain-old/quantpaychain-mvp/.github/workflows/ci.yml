
name: CI/CD Pipeline

on:
  push:
    branches: [ main, fix/vercel-deploy ]
  pull_request:
    branches: [ main, fix/vercel-deploy ]

jobs:
  frontend-build:
    name: Frontend Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/app/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend/app
        run: npm ci

      - name: Build frontend
        working-directory: frontend/app
        run: npm run build

      - name: Check build output
        working-directory: frontend/app
        run: |
          if [ -d ".next" ]; then
            echo "‚úÖ Frontend build successful"
            ls -la .next
          else
            echo "‚ùå Frontend build failed - .next directory not found"
            exit 1
          fi

  contracts-test:
    name: Smart Contracts Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: contracts/package-lock.json

      - name: Install contract dependencies
        working-directory: contracts
        run: npm ci

      - name: Compile contracts
        working-directory: contracts
        run: npm run compile

      - name: Run contract tests
        working-directory: contracts
        run: npm test

      - name: Check test results
        working-directory: contracts
        run: |
          echo "‚úÖ All contract tests passed"

  lint-and-format:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Check file structure
        run: |
          echo "üìÅ Checking project structure..."
          if [ -d "frontend/app" ]; then
            echo "‚úÖ Frontend directory exists"
          else
            echo "‚ùå Frontend directory missing"
            exit 1
          fi
          
          if [ -d "contracts" ]; then
            echo "‚úÖ Contracts directory exists"
          else
            echo "‚ùå Contracts directory missing"
            exit 1
          fi
          
          if [ -f "contracts/contracts/PermissionedToken.sol" ]; then
            echo "‚úÖ PermissionedToken.sol exists"
          else
            echo "‚ùå PermissionedToken.sol missing"
            exit 1
          fi
          
          if [ -f "contracts/contracts/Dividends.sol" ]; then
            echo "‚úÖ Dividends.sol exists"
          else
            echo "‚ùå Dividends.sol missing"
            exit 1
          fi

  deployment-check:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    needs: [frontend-build, contracts-test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check deployment files
        run: |
          echo "üîç Checking deployment configuration..."
          
          if [ -f "vercel.json" ]; then
            echo "‚úÖ vercel.json exists"
          else
            echo "‚ö†Ô∏è vercel.json not found"
          fi
          
          if [ -f "contracts/hardhat.config.ts" ]; then
            echo "‚úÖ hardhat.config.ts exists"
          else
            echo "‚ùå hardhat.config.ts missing"
            exit 1
          fi
          
          if [ -f "ENV_SAMPLE" ]; then
            echo "‚úÖ ENV_SAMPLE exists"
          else
            echo "‚ö†Ô∏è ENV_SAMPLE not found"
          fi

      - name: Deployment summary
        run: |
          echo "üìã Deployment Summary"
          echo "===================="
          echo "‚úÖ Frontend build: PASSED"
          echo "‚úÖ Contract tests: PASSED"
          echo "‚úÖ Project structure: VALID"
          echo "üöÄ Ready for deployment"
